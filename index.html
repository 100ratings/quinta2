<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Training QUINTA ‚Äî v1.4</title>
<style>
  :root{--bg:#0f1115;--fg:#e6e6e6;--muted:#9aa3b2;--ok:#19c37d;--err:#ff5c5c;--card:#151923;--accent:#7aa2ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:880px;margin:36px auto;padding:0 20px}
  .card{background:var(--card);border:1px solid #202637;border-radius:12px;padding:18px}
  h1{font-size:20px;margin:0 0 8px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .big{font-size:28px;font-weight:700}
  .muted{color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a3242;background:#131827;font-size:12px}
  button{background:#1d2433;color:var(--fg);border:1px solid #2a3242;border-radius:10px;padding:11px 14px;font-size:15px;cursor:pointer}
  button:hover{border-color:#3a4760}
  .kbd{font-family:ui-monospace,Consolas,Menlo,monospace;background:#111521;border:1px solid #273047;border-radius:6px;padding:2px 6px;font-size:12px}
  .stats{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .stat{background:#121726;border:1px solid #20283a;border-radius:8px;padding:8px 10px;font-size:13px}
  .feedback{margin-top:8px;font-size:16px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .board{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px}
  .item{border:1px solid #2a3242;border-radius:10px;padding:10px;text-align:center;user-select:none}
  .item.btn{cursor:pointer;transition:border-color .15s, background .15s}
  .item.btn:hover{border-color:#3a4760;background:#182036}
  .force{outline:2px solid var(--accent)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}
  .seg{display:flex;border:1px solid #2a3242;border-radius:10px;overflow:hidden}
  .seg input{display:none}
  .seg label{padding:9px 12px;cursor:pointer}
  .seg input:checked + label{background:#2a3347}
  /* ==== Modals (scroll apenas dentro) ==== */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:#0008;padding:20px;z-index:999}
  .modal .inner{max-width:900px;width:100%;background:#0f121d;border:1px solid #2a3242;border-radius:12px;padding:18px;
                max-height:85vh;overflow:auto} /* <- rola s√≥ o conte√∫do do modal */
  .modal h2{margin:0 0 8px;font-size:18px}
  .legend{font-size:14px;color:var(--muted)}
  .legend b{color:#cfd8ea}
  .hr{height:1px;background:#2a3242;margin:12px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .manualResult{font-size:14px;margin-left:4px}
  .hide{display:none!important}
  footer{margin-top:12px;text-align:center;font-size:12px;color:var(--muted)}
  select, input[type="number"]{background:#0d1017;border:1px solid #2a3242;color:#e6e6e6;border-radius:8px;padding:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Training <span class="muted">QUINTA ‚Äî Quick Mechanics</span></h1>

    <div class="row" style="margin:6px 0 10px">
      <button id="nextBtn" title="Shortcut: N">Generate number <span class="kbd">N</span></button>
      <button id="checkBtn" title="Shortcut: Enter">Check <span class="kbd">Enter</span></button>
      <button id="helpBtn" title="Shortcut: H">Help <span class="kbd">H</span></button>
      <button id="qsBtn" title="Shortcut: Q">Quick Start Guide <span class="kbd">Q</span></button>

      <span class="pill">Range:
        <select id="range">
          <option value="1-40" selected>1‚Äì40 (default)</option>
          <option value="1-15">1‚Äì15</option>
          <option value="15-30">15‚Äì30</option>
          <option value="1-30">1‚Äì30</option>
          <option value="30-45">30‚Äì45</option>
          <option value="45-60">45‚Äì60</option>
          <option value="30-60">30‚Äì60</option>
          <option value="1-60">1‚Äì60</option>
          <option value="custom">Custom‚Ä¶</option>
        </select>
      </span>
      <span id="customWrap" class="pill" style="display:none">
        <input id="minN" type="number" value="1" style="width:80px"> ‚Äì
        <input id="maxN" type="number" value="15" style="width:80px">
      </span>

      <span class="pill"><label><input id="adaptiveCB" type="checkbox" checked> Adaptive</label></span>

      <span class="pill"><label><input id="fastCB" type="checkbox" checked> Fast Tap Mode</label></span>

      <span class="pill">
        <label style="margin-right:6px"><input id="ttsCB" type="checkbox"> Speak number</label>
        <select id="voiceSel" title="Select voice" style="max-width:260px">
          <option value="">Auto (by language)</option>
        </select>
      </span>

      <button id="resetBtn" title="Reset learning">Reset training</button>
    </div>

    <div class="row" style="margin:0 0 8px">
      <span class="pill">
        Enter N:
        <input id="manualN" type="number" inputmode="numeric" placeholder="e.g. 33" style="width:90px;margin-left:6px">
      </span>
      <button id="analyzeBtn" title="Shortcut: Ctrl+Enter">Find side & type</button>
      <span id="manualOut" class="manualResult muted">‚Äî</span>
    </div>

    <div class="big" id="number">‚Äî</div>
    <div class="legend" id="hint">
      Fast Tap Mode: <b>tap where you‚Äôd say ‚Äú1‚Äù</b>. (Force is the <b>2nd from the left</b>.)
    </div>

    <div class="board" aria-label="row of 5 items" id="board">
      <div class="item btn" data-idx="0">1st</div>
      <div class="item force btn" data-idx="1">2nd (force)</div>
      <div class="item btn" data-idx="2">3rd</div>
      <div class="item btn" data-idx="3">4th</div>
      <div class="item btn" data-idx="4">5th</div>
    </div>

    <div class="controls" id="advancedControls">
      <div class="seg" role="radiogroup" aria-label="Counting type">
        <input id="tBasic" name="tipo" type="radio" checked><label for="tBasic">Basic</label>
        <input id="tBounce" name="tipo" type="radio"><label for="tBounce">Bounce</label>
      </div>
      <div class="seg" role="radiogroup" aria-label="Starting side">
        <input id="sLeft" name="side" type="radio" checked><label for="sLeft">Left</label>
        <input id="sRight" name="side" type="radio"><label for="sRight">Right</label>
      </div>
      <span class="pill">Step-by-step <input id="step" type="checkbox" style="vertical-align:middle"></span>
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="stats">
      <div class="stat">Correct: <b id="ok">0</b></div>
      <div class="stat">Wrong: <b id="err">0</b></div>
      <div class="stat">Time: <b id="timer">0.0s</b></div>
      <!-- Avg(20) removido -->
    </div>
  </div>

  <div class="legend" style="margin-top:12px; text-align:center; font-size:13px">
    üí° Feedback? Bugs or suggestions ‚Üí
    <a href="mailto:magicodemian@hotmail.com">magicodemian@hotmail.com</a>
  </div>
</div>

<!-- Help modal -->
<div class="modal" id="modal">
  <div class="inner">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Quick rules & reminders</h2>
      <button id="closeHelp">Close</button>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div>
        <h3 style="margin:0 0 6px">Core of the method</h3>
        <div class="legend">
          ‚Ä¢ Force 1 item among 5; the force item is always the <b>2nd from the left</b> (fixed).<br>
          ‚Ä¢ <b>Type:</b> even <i>N</i> ‚Üí <b>Basic</b>; odd <i>N</i> ‚Üí <b>Bounce</b>.<br>
          ‚Ä¢ <b>Side (Basic):</b> start on the <b>left</b> if <code>N ‚â° 0 or 2 (mod 8)</code>, otherwise on the <b>right</b>.<br>
          ‚Ä¢ <b>Side (Bounce):</b> use <b>N+1</b> with the same rule (and count <i>moves</i>).<br>
          ‚Ä¢ ‚ÄúBasic‚Äù counts <i>points</i> 1,2,3,4,5,4,3,2,1‚Ä¶; ‚ÄúBounce‚Äù counts <i>moves</i>.
        </div>
        <div class="hr"></div>
        <h3 style="margin:0 0 6px">New features in v1.4</h3>
        <div class="legend">
          ‚Ä¢ <b>Fast Tap Mode</b>: toque direto no quadrado onde voc√™ diria ‚Äú1‚Äù ‚Äî sem precisar definir tipo/side nem apertar Check.<br>
          ‚Ä¢ <b>Speak number</b> (TTS) com <b>auto-idioma</b> e <b>seletor de voz</b> manual.<br>
          ‚Ä¢ <b>Adaptive</b>: refor√ßa os casos que est√£o mais lentos/dif√≠ceis.<br>
          ‚Ä¢ <b>Modals rol√°veis</b> no celular (Help e Quick Start).<br>
          ‚Ä¢ ‚ÄúAvg(20)‚Äù removido da UI, mantendo estat√≠sticas simples (Time por rodada).
        </div>
        <div class="hr"></div>
        <h3 style="margin:0 0 6px">Tips</h3>
        <div class="legend">
          ‚Ä¢ Atalhos: <span class="kbd">N</span> Generate ‚Ä¢ <span class="kbd">Enter</span> Check ‚Ä¢ <span class="kbd">H</span> Help ‚Ä¢ <span class="kbd">Q</span> Quick Start ‚Ä¢ <span class="kbd">Ctrl+Enter</span> Analyze N.<br>
          ‚Ä¢ Dire√ß√µes: <span class="kbd">‚Üë/‚Üì</span>/<span class="kbd">W/S</span> Basic/Bounce ‚Ä¢ <span class="kbd">‚Üê/‚Üí</span>/<span class="kbd">A/D</span> Left/Right ‚Ä¢ <span class="kbd">Space</span> alterna tipo.<br>
          ‚Ä¢ <b>Auto-advance</b>: ao acertar, o pr√≥ximo n√∫mero √© gerado automaticamente.<br>
          ‚Ä¢ Em iOS, as vozes aparecem ap√≥s a primeira intera√ß√£o (limita√ß√£o do Safari).
        </div>
      </div>

      <div>
        <h3 style="margin:0 0 6px">Cheat-sheet</h3>
        <div class="legend">
          <b>Type:</b> even N ‚Üí Basic; odd N ‚Üí Bounce. <br/>
          <b>Side (Basic):</b> Left if N ‚â° 0 or 2 (mod 8); else Right. <br/>
          <b>Side (Bounce):</b> apply rule to N+1. <br/>
          <b>Fast Tap:</b> toque onde voc√™ diria ‚Äú1‚Äù. <br/>
          <b>TTS:</b> marque ‚ÄúSpeak number‚Äù e, se quiser, escolha a voz no seletor ao lado.
        </div>
        <div class="hr"></div>
        <h3 style="margin:0 0 6px">About the book</h3>
        <div class="legend">
          To go deeper into QUINTA, check <i>Quinta: A Miracle in Five Parts</i>:
          <a href="https://phillsmithcreative.com/collections/books/products/quinta-book" target="_blank">official link</a>.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Start Guide modal -->
<div class="modal" id="qsModal">
  <div class="inner">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Quick Start Guide</h2>
      <button id="closeQS" title="Close">Close</button>
    </div>
    <div class="hr"></div>

    <div class="grid2">
      <div>
        <h3 style="margin:0 0 6px">What this trainer is</h3>
        <div class="legend">
          Practice the mechanics to force the <b>2nd from the left</b> among five by choosing the correct
          <b>Counting Type</b> and <b>Starting Side</b> for any <i>N</i>.
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 6px">2-minute flow</h3>
        <ol class="legend" style="padding-left:18px">
          <li>Choose a <b>Range</b> (or set <b>Custom</b>). Keep <b>Adaptive</b> on.</li>
          <li>Press <b>Generate number</b> (<span class="kbd">N</span>).</li>
          <li><b>Fast Tap Mode</b>: toque onde diria ‚Äú1‚Äù. (Ou desligue para usar Type/Side + Check.)</li>
          <li>(Optional) Enable <b>Speak number</b> e selecione uma voz no dropdown.</li>
          <li>Ao acertar, um novo n√∫mero √© gerado automaticamente.</li>
        </ol>

        <div class="hr"></div>
        <h3 style="margin:0 0 6px">Manual mode</h3>
        <div class="legend">
          Digite um <b>N</b> e clique <b>Find side &amp; type</b> (ou <span class="kbd">Ctrl+Enter</span>) para ver a resposta ideal.
        </div>
      </div>

      <div>
        <h3 style="margin:0 0 6px">Shortcuts & tips</h3>
        <div class="legend">
          <b>Shortcuts:</b> <span class="kbd">N</span>, <span class="kbd">Enter</span>, <span class="kbd">Ctrl+Enter</span>, <span class="kbd">H</span>, <span class="kbd">Q</span>.<br/>
          <b>Arrows/WASD:</b> tipo e lado (quando n√£o estiver em Fast Tap).<br/>
          <b>TTS:</b> auto-idioma (navegador/HTML) + seletor manual; Safari iOS pode atrasar o carregamento das vozes at√© a 1¬™ intera√ß√£o.<br/>
          <b>Reset:</b> limpa estat√≠sticas e pesos adaptativos.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(()=>{

  // ====== QS helpers ======
  const $ = s => document.querySelector(s);
  const numberEl=$('#number'),feedback=$('#feedback');
  const okEl=$('#ok'),errEl=$('#err'),timerEl=$('#timer');
  const nextBtn=$('#nextBtn'),checkBtn=$('#checkBtn'),resetBtn=$('#resetBtn');
  const helpBtn=$('#helpBtn'),modal=$('#modal'),closeHelp=$('#closeHelp');
  const qsBtn=$('#qsBtn'),qsModal=$('#qsModal'),closeQS=$('#closeQS');
  const tBasic=$('#tBasic'),tBounce=$('#tBounce'),sLeft=$('#sLeft'),sRight=$('#sRight');
  const stepCB=$('#step');
  const rangeSel=$('#range'),customWrap=$('#customWrap'),minN=$('#minN'),maxN=$('#maxN');
  const adaptiveCB=$('#adaptiveCB'),fastCB=$('#fastCB'),ttsCB=$('#ttsCB');
  const voiceSel=$('#voiceSel');
  const manualN=$('#manualN'),analyzeBtn=$('#analyzeBtn'),manualOut=$('#manualOut');
  const board=$('#board'),advancedControls=$('#advancedControls'),hintEl=$('#hint');

  let N=null,lastN=null,startTime=0,ok=0,err=0,locked=false;
  let weights=[1,1,1,1]; // BL, BR, bL, bR

  // ====== timer ======
  function now(){return performance.now()}
  function updateTimer(){ if(startTime){timerEl.textContent=((now()-startTime)/1000).toFixed(1)+'s';} requestAnimationFrame(updateTimer) }
  requestAnimationFrame(updateTimer);

  // ====== range ======
  function currentRange(){
    if(rangeSel.value==='custom'){
      let a=parseInt(minN.value||'1',10), b=parseInt(maxN.value||'15',10);
      if(a>b)[a,b]=[b,a]; return [Math.max(1,a), Math.min(9999,b)];
    }
    return rangeSel.value.split('-').map(x=>parseInt(x,10));
  }

  // ====== rules ======
  function correctRule(n){
    const tipo=(n%2===0)?'basic':'bounce';
    const m=(tipo==='bounce')?n+1:n;
    const r=((m%8)+8)%8;
    const lado=(r===0||r===2)?'left':'right';
    return {tipo,lado,r,m};
  }
  function bucketFromRule(rule){
    if(rule.tipo==='basic'&&rule.lado==='left') return 0;
    if(rule.tipo==='basic'&&rule.lado==='right') return 1;
    if(rule.tipo==='bounce'&&rule.lado==='left') return 2;
    return 3;
  }

  // ====== adaptive generator ======
  function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
  function sampleBucketAvailable(a,b){
    const seen=new Set();
    for(let i=0;i<400 && seen.size<4;i++){ seen.add(bucketFromRule(correctRule(randInt(a,b)))); }
    return seen;
  }
  function pickBucket(a,b){
    const avail=sampleBucketAvailable(a,b);
    const eff=[0,0,0,0]; let sum=0;
    for(let i=0;i<4;i++){
      if(avail.has(i)){ eff[i]=adaptiveCB.checked?Math.max(0.05,weights[i]):1; sum+=eff[i]; }
    }
    let r=Math.random()*sum;
    for(let i=0;i<4;i++){ if(!avail.has(i)) continue; if(r<eff[i]) return i; r-=eff[i]; }
    for(let i=0;i<4;i++) if(avail.has(i)) return i;
    return 0;
  }

  // ====== TTS voices (auto + manual) ======
  let _voices=[];
  function loadVoices(){
    _voices = window.speechSynthesis.getVoices() || [];
    populateVoiceSelect();
  }
  function populateVoiceSelect(){
    const prev=voiceSel.value;
    voiceSel.innerHTML='<option value="">Auto (by language)</option>';
    const preferred = ['pt-','en-','es-','fr-','de-','it-','ja-','zh-','ko-'];
    const sorted=[..._voices].sort((a,b)=>{
      const ap = preferred.findIndex(p=>a.lang && a.lang.toLowerCase().startsWith(p));
      const bp = preferred.findIndex(p=>b.lang && b.lang.toLowerCase().startsWith(p));
      return (ap===-1)-(bp===-1) || (a.lang||'').localeCompare(b.lang||'') || a.name.localeCompare(b.name);
    });
    sorted.forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v.name;
      opt.textContent=`${v.lang} ‚Äî ${v.name}`;
      voiceSel.appendChild(opt);
    });
    // restaura sele√ß√£o anterior se existir
    if([...voiceSel.options].some(o=>o.value===prev)) voiceSel.value=prev;
  }
  function getTargetLang(){
    return document.documentElement.lang || navigator.language || 'pt-BR';
  }
  function pickBestVoice(target){
    const t=target.toLowerCase(), base=t.split('-')[0];
    return _voices.find(v=>v.lang&&v.lang.toLowerCase()===t)
        || _voices.find(v=>v.lang&&v.lang.toLowerCase().startsWith(base))
        || null;
  }
  function speakNumber(n){
    if(!ttsCB.checked) return;
    try{
      const u=new SpeechSynthesisUtterance(String(n));
      const selName = voiceSel.value;
      if(selName){
        const v=_voices.find(v=>v.name===selName);
        if(v){ u.voice=v; u.lang=v.lang||u.lang; }
      }else{
        const lang=getTargetLang();
        const v=pickBestVoice(lang);
        if(v){ u.voice=v; u.lang=v.lang; } else { u.lang=lang; }
      }
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }
  // iOS/Safari s√≥ libera vozes ap√≥s intera√ß√£o; ainda assim tentamos carregar:
  loadVoices();
  if('onvoiceschanged' in speechSynthesis){
    speechSynthesis.onvoiceschanged = loadVoices;
  }

  // ====== core flow ======
  function newNumber(){
    const[a,b]=currentRange();
    const targetBucket=pickBucket(a,b);
    let candidate=null, tries=0;
    while(tries++<400){
      const x=randInt(a,b);
      if(x===lastN && b>a) continue;
      if(bucketFromRule(correctRule(x))===targetBucket){ candidate=x; break; }
    }
    if(candidate===null){ do{ candidate=(a===b? a : randInt(a,b)); } while(candidate===lastN && b>a); }

    N=candidate; lastN=N;
    numberEl.textContent=String(N);
    startTime=now(); feedback.textContent=''; locked=false;

    hintEl.innerHTML = fastCB.checked
      ? `Fast Tap Mode: <b>tap where you‚Äôd say ‚Äú1‚Äù</b>. (Force is the <b>2nd from the left</b>.)`
      : `Generate a number and choose the counting type and the side. The force item is always the <b>2nd from the left</b>.`;

    speakNumber(N);
  }

  function simulate(n,tipo,lado,step=false){
    const target=1; let pos=(lado==='left')?0:4; let dir=(lado==='left')?+1:-1; const log=[];
    if(tipo==='basic'){
      let count=0; while(count<n){ count++; if(step) log.push({count,pos}); if(count===n) break; pos+=dir; if(pos===4||pos===0) dir*=-1; }
    }else{
      let moves=0; while(moves<n){ pos+=dir; moves++; if(step) log.push({count:moves,pos}); if(pos===4||pos===0) dir*=-1; }
    }
    return {hit:(pos===target),pos,log};
  }
  function userSelection(){ return {tipo: (tBasic.checked?'basic':'bounce'), lado: (sLeft.checked?'left':'right')} }

  function updateAdaptiveWeights(bucket, elapsed){
    if(!adaptiveCB.checked) return;
    const SLOW=5.0, FAST=3.0, UP=0.3, DOWN=0.2, MIN=0.2, MAX=3.0;
    if(elapsed>=SLOW) weights[bucket]=Math.min(MAX,weights[bucket]+UP);
    else if(elapsed<=FAST) weights[bucket]=Math.max(MIN,weights[bucket]-DOWN);
    else weights[bucket]+= (1-weights[bucket])*0.05;
  }

  function verify(){
    if(locked||N==null) return; locked=true;
    const elapsed=(now()-startTime)/1000;
    const ideal=correctRule(N);
    const sel=userSelection();
    const sim=simulate(N, sel.tipo, sel.lado, stepCB.checked);
    const idealTxt=`${ideal.tipo==='basic'?'Basic':'Bounce'} + ${ideal.lado==='left'?'Left':'Right'}`;
    const userTxt =`${sel.tipo==='basic'?'Basic':'Bounce'} + ${sel.lado==='left'?'Left':'Right'}`;
    if(sim.hit){
      ok++; feedback.innerHTML=`<span class="ok">Correct!</span> <span class="muted">(${userTxt}) ‚Äî ${elapsed.toFixed(1)}s</span>`;
      setTimeout(newNumber,500);
    }else{
      err++; feedback.innerHTML=`<span class="err">Wrong.</span> <span class="muted">You chose ${userTxt}. Ideal: <b>${idealTxt}</b>. ‚Äî ${elapsed.toFixed(1)}s</span>`;
      if(stepCB.checked && sim.log.length){
        const path=sim.log.map(s=>s.pos+1).join(' ‚Üí ');
        feedback.innerHTML+=`<div class="muted" style="margin-top:6px">Path: ${path}</div>`;
      }
    }
    okEl.textContent=ok; errEl.textContent=err;
    updateAdaptiveWeights(bucketFromRule(ideal), elapsed);
  }

  function fastTap(idx){
    if(locked||N==null) return; locked=true;
    const elapsed=(now()-startTime)/1000;
    const ideal=correctRule(N);
    const startIdx=(ideal.lado==='left')?0:4;
    const isRight=(idx===startIdx);
    if(isRight){
      ok++; feedback.innerHTML=`<span class="ok">Correct!</span> <span class="muted">(Start: <b>${ideal.lado==='left'?'Left':'Right'}</b>; Type: <b>${ideal.tipo==='basic'?'Basic':'Bounce'}</b>) ‚Äî ${elapsed.toFixed(1)}s</span>`;
      setTimeout(newNumber,350);
    }else{
      err++; feedback.innerHTML=`<span class="err">Wrong.</span> <span class="muted">You tapped ${idx+1}¬∫. Ideal start is <b>${ideal.lado==='left'?'Left (1¬∫)':'Right (5¬∫)'}</b>; Type: <b>${ideal.tipo==='basic'?'Basic':'Bounce'}</b>. ‚Äî ${elapsed.toFixed(1)}s</span>`;
    }
    okEl.textContent=ok; errEl.textContent=err;
    updateAdaptiveWeights(bucketFromRule(ideal), elapsed);
  }
  window.fastTap=fastTap; // fallback inline

  // ====== events ======
  nextBtn.addEventListener('click', newNumber);
  checkBtn.addEventListener('click', ()=>{ if(!fastCB.checked) verify(); });
  helpBtn.addEventListener('click', ()=> modal.style.display='grid');
  $('#closeHelp').addEventListener('click', ()=> modal.style.display='none');
  qsBtn.addEventListener('click', ()=> qsModal.style.display='grid');
  closeQS.addEventListener('click', ()=> qsModal.style.display='none');

  rangeSel.addEventListener('change', ()=> customWrap.style.display=(rangeSel.value==='custom'?'inline-flex':'none'));
  resetBtn.addEventListener('click', ()=>{
    ok=err=0; okEl.textContent=0; errEl.textContent=0;
    lastN=null; feedback.textContent=''; manualOut.textContent='‚Äî'; manualN.value='';
    weights=[1,1,1,1]; newNumber();
  });

  // atalhos
  document.addEventListener('keydown', (e)=>{
    const kRaw=e.key||''; const k=kRaw.toLowerCase();
    if(k==='n'){ e.preventDefault(); newNumber(); return; }
    if(kRaw==='Enter' && !e.ctrlKey){ e.preventDefault(); if(!fastCB.checked) verify(); return; }
    if(kRaw==='Enter' && e.ctrlKey){ e.preventDefault(); analyzeManual(); return; }
    if(k==='h'){ e.preventDefault(); modal.style.display='grid'; return; }
    if(k==='q'){ e.preventDefault(); qsModal.style.display='grid'; return; }

    const el=document.activeElement;
    const isEditable=el && (el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.isContentEditable||el.tagName==='SELECT');
    if(isEditable) return;

    if(['arrowup','w'].includes(k)){ e.preventDefault(); tBasic.checked=true; return; }
    if(['arrowdown','s'].includes(k)){ e.preventDefault(); tBounce.checked=true; return; }
    if(['arrowleft','a'].includes(k)){ e.preventDefault(); sLeft.checked=true; return; }
    if(['arrowright','d'].includes(k)){ e.preventDefault(); sRight.checked=true; return; }
    if(k===' '||k==='spacebar'){ e.preventDefault(); (tBasic.checked?tBounce:tBasic).checked=true; return; }
  });

  // analyze manual
  function analyzeManual(){
    const raw=manualN.value.trim();
    if(!raw){ manualOut.textContent='‚Äî'; return; }
    const n=Number(raw);
    if(!Number.isFinite(n)||!Number.isInteger(n)||n<=0){
      manualOut.innerHTML=`<span class="err">Enter a positive integer.</span>`; return;
    }
    const rule=correctRule(n);
    (rule.tipo==='basic'?tBasic:tBounce).checked=true;
    (rule.lado==='left'?sLeft:sRight).checked=true;
    manualOut.innerHTML=`<span class="ok">${rule.tipo==='basic'?'Basic':'Bounce'} + ${rule.lado==='left'?'Left':'Right'}</span> <span class="muted">(N=${n}${rule.tipo==='bounce'?', use N+1='+(rule.m):''}; mod8=${rule.r})</span>`;
  }
  analyzeBtn.addEventListener('click', analyzeManual);
  manualN.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); analyzeManual(); } });

  // Fast Tap handlers (click + touch) + fallback inline onclick
  function getIdxFromEvent(ev){
    const t=ev.target.closest('.item');
    if(!t || !board.contains(t)) return null;
    const idx=Number(t.dataset.idx);
    return Number.isInteger(idx)?idx:null;
  }
  function onTap(ev){
    if(ev.type==='touchstart') ev.preventDefault();
    const idx=getIdxFromEvent(ev);
    if(idx==null || !fastCB.checked) return;
    const el=ev.target.closest('.item');
    if(el){ el.style.outline='2px solid #7aa2ff'; setTimeout(()=>el.style.outline='',120); }
    fastTap(idx);
  }
  board.addEventListener('click', onTap, {passive:true});
  board.addEventListener('touchstart', onTap, {passive:false});
  Array.from(board.querySelectorAll('.item')).forEach((el)=>{
    const idx=Number(el.dataset.idx);
    if(Number.isInteger(idx)) el.setAttribute('onclick', `window.fastTap && window.fastTap(${idx})`);
  });

  // UI toggle (esconde controles no Fast Tap)
  function syncFastModeUI(){
    const on=fastCB.checked;
    advancedControls.classList.toggle('hide', on);
    checkBtn.classList.toggle('hide', on);
    hintEl.innerHTML = on
      ? `Fast Tap Mode: <b>tap where you‚Äôd say ‚Äú1‚Äù</b>. (Force is the <b>2nd from the left</b>.)`
      : `Generate a number and choose the counting type and the side. The force item is always the <b>2nd from the left</b>.`;
  }
  fastCB.addEventListener('change', syncFastModeUI);

  // primeira carga
  syncFastModeUI();
  newNumber();

})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Training QUINTA ‚Äî v1.4.7</title>

<!-- iOS fullscreen / PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="QUINTA Trainer">
<link rel="apple-touch-icon" href="icon.png">

<style>
  :root{
    --bg:#0f1115;--fg:#e6e6e6;--muted:#9aa3b2;--ok:#19c37d;--err:#ff5c5c;
    --card:#151923;--accent:#7aa2ff; /* azul da v1.4.6 */
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:880px;margin:36px auto;padding:0 20px}
  .card{background:var(--card);border:1px solid #202637;border-radius:12px;padding:18px}
  h1{font-size:20px;margin:0 0 8px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .big{font-size:28px;font-weight:700}
  .muted{color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a3242;background:#131827;font-size:12px;display:inline-flex;align-items:center;gap:6px}
  button{background:#1d2433;color:var(--fg);border:1px solid #2a3242;border-radius:10px;padding:11px 14px;font-size:15px;cursor:pointer}
  button:hover{border-color:#3a4760}
  .kbd{font-family:ui-monospace,Consolas,Menlo,monospace;background:#111521;border:1px solid #273047;border-radius:6px;padding:2px 6px;font-size:12px}
  .stats{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .stat{background:#121726;border:1px solid #20283a;border-radius:8px;padding:8px 10px;font-size:13px}
  .feedback{margin-top:8px;font-size:16px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .board{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px}
  .item{border:1px solid #2a3242;border-radius:10px;padding:10px;text-align:center;user-select:none}
  .item.btn{cursor:pointer;transition:border-color .15s, background .15s}
  .item.btn:hover{border-color:#3a4760;background:#182036}
  .force{outline:2px solid var(--accent)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}
  .seg{display:flex;border:1px solid #2a3242;border-radius:10px;overflow:hidden}
  .seg input{display:none}
  .seg label{padding:9px 12px;cursor:pointer}
  .seg input:checked + label{background:#2a3347}

  .modal{position:fixed;inset:0;display:none;place-items:center;background:#0008;padding:20px;z-index:999}
  .modal .inner{max-width:900px;width:100%;background:#0f121d;border:1px solid #2a3242;border-radius:12px;padding:18px;max-height:85vh;overflow:auto}
  .modal h2{margin:0 0 8px;font-size:18px}
  .legend{font-size:14px;color:var(--muted)}
  .legend b{color:#cfd8ea}
  .hr{height:1px;background:#2a3242;margin:12px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .manualResult{font-size:14px;margin-left:4px}
  .hide{display:none!important}
  footer{margin-top:12px;text-align:center;font-size:12px;color:#9aa3b2}
  select, input[type="number"]{background:#0d1017;border:1px solid #2a3242;color:#e6e6e6;border-radius:8px;padding:6px}

  button, a { -webkit-tap-highlight-color: transparent; }
  button:focus, button:focus-visible { outline: none; }

  /* (1) Email com a mesma cor do 2nd (force) */
  a[href^="mailto:"]{ color: var(--accent); text-decoration-color: var(--accent); }
  a[href^="mailto:"]:hover{ filter: brightness(1.12); }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Training <span class="muted">QUINTA ‚Äî v1.4.7</span></h1>

    <div class="row" style="margin:6px 0 10px">
      <button id="nextBtn" title="Shortcut: N">Generate number <span class="kbd">N</span></button>
      <button id="checkBtn" title="Shortcut: Enter">Check <span class="kbd">Enter</span></button>
      <button id="helpBtn" title="Shortcut: H">Help <span class="kbd">H</span></button>
      <button id="qsBtn" title="Shortcut: Q">Quick Start Guide <span class="kbd">Q</span></button>

      <span class="pill">Range:
        <select id="range">
          <option value="1-40" selected>1‚Äì40 (default)</option>
          <option value="1-15">1‚Äì15</option>
          <option value="15-30">15‚Äì30</option>
          <option value="1-30">1‚Äì30</option>
          <option value="30-45">30‚Äì45</option>
          <option value="45-60">45‚Äì60</option>
          <option value="30-60">30‚Äì60</option>
          <option value="1-60">1‚Äì60</option>
          <option value="custom">Custom‚Ä¶</option>
        </select>
      </span>
      <span id="customWrap" class="pill" style="display:none">
        <input id="minN" type="number" value="1" style="width:80px"> ‚Äì 
        <input id="maxN" type="number" value="15" style="width:80px">
      </span>

      <span class="pill"><label><input id="adaptiveCB" type="checkbox" checked> Adaptive</label></span>
      <span class="pill"><button id="adaptCfgBtn" title="Adaptive settings" disabled>Adaptive settings ‚öôÔ∏è</button></span>
      <span class="pill"><label><input id="fastCB" type="checkbox" checked> Fast Tap Mode</label></span>

      <span class="pill">
        <label style="margin-right:6px"><input id="ttsCB" type="checkbox" checked> Speak number</label>
        <select id="voiceSel" title="Select voice" style="max-width:260px">
          <option value="">Auto (by language)</option>
        </select>
        <label style="margin-left:6px"><input id="errTtsCB" type="checkbox" checked> Speak errors</label>
      </span>

    </div>

    <div class="row" style="margin:0 0 8px">
      <span class="pill">
        Enter N:
        <input id="manualN" type="number" inputmode="numeric" placeholder="e.g. 33" style="width:90px;margin-left:6px">
      </span>
      <button id="analyzeBtn" title="Shortcut: Ctrl+Enter">Find side & type</button>
      <span id="manualOut" class="manualResult muted"></span>
    </div>

    <div class="big" id="number">‚Äî</div>
    <div class="legend" id="hint">
      Fast Tap Mode: <b>tap where you‚Äôd say "1"</b>. (Force is the <b>2nd from the left</b>.)
    </div>

    <div class="board" aria-label="row of 5 items" id="board">
      <div class="item btn" data-idx="0">1st</div>
      <div class="item force btn" data-idx="1">2nd (force)</div>
      <div class="item btn" data-idx="2">3rd</div>
      <div class="item btn" data-idx="3">4th</div>
      <div class="item btn" data-idx="4">5th</div>
    </div>

    <div class="controls" id="advancedControls">
      <div class="seg" role="radiogroup" aria-label="Counting type">
        <input id="tBasic" name="tipo" type="radio" checked><label for="tBasic">Basic</label>
        <input id="tBounce" name="tipo" type="radio"><label for="tBounce">Bounce</label>
      </div>
      <div class="seg" role="radiogroup" aria-label="Starting side">
        <input id="sLeft" name="side" type="radio" checked><label for="sLeft">Left</label>
        <input id="sRight" name="side" type="radio"><label for="sRight">Right</label>
      </div>
      <span class="pill">Step-by-step <input id="step" type="checkbox" style="vertical-align:middle"></span>
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="stats">
      <div class="stat">Correct: <b id="ok">0</b></div>
      <div class="stat">Wrong: <b id="err">0</b></div>
      <div class="stat">Time: <b id="timer">0.0s</b></div>
    </div>

    <div class="legend" id="timeLegend" style="margin-top:-4px">Good ‚â§ 3.0s ‚Ä¢ Slow ‚â• 5.0s</div>

  </div>

  <div class="legend" style="margin-top:12px; text-align:center; font-size:13px">
    üí° Feedback? Bugs or suggestions ‚Üí
    <a href="mailto:magicodemian@hotmail.com">magicodemian@hotmail.com</a>
  </div>
</div>

<!-- Help modal -->
<div class="modal" id="modal">
  <div class="inner">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Quick rules &amp; reminders</h2>
      <button id="closeHelp">Close</button>
    </div>
    <div class="hr"></div>

    <div class="grid2">
      <div>
        <h3 style="margin:0 0 6px">Core of the method</h3>
        <div class="legend">
          ‚Ä¢ You always force the <b>2nd from the left</b> out of five (fixed).<br>
          ‚Ä¢ <b>Type:</b> even <i>N</i> ‚Üí <b>Basic</b>; odd <i>N</i> ‚Üí <b>Bounce</b>.<br>
          ‚Ä¢ <b>Side (Basic):</b> start on the <b>left</b> if <code>N ‚â° 0 or 2 (mod 8)</code>, otherwise start on the <b>right</b>.<br>
          ‚Ä¢ <b>Side (Bounce):</b> apply the same rule to <b>N + 1</b> and count <i>moves</i> (not points).<br>
          ‚Ä¢ Mental model: <i>Basic</i> counts points (1‚Äì5‚Äì1‚Ä¶), <i>Bounce</i> counts steps between positions.
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 6px">What‚Äôs new in v1.4.x</h3>
        <div class="legend">
          ‚Ä¢ <b>Fast Tap Mode</b>: just tap where you‚Äôd say "1" ‚Äî no Type/Side or Check needed.<br>
          ‚Ä¢ <b>Speak number</b> (TTS) with Auto (by language) + manual voice selector.<br>
          ‚Ä¢ <b>Speak errors</b>: short "wrong" cue in your selected language when you miss.<br>
          ‚Ä¢ <b>Adaptive</b>: surfaces buckets where you‚Äôre currently slower.<br>
          ‚Ä¢ Mobile-friendly: Help &amp; Quick Start modals scroll smoothly on small screens.
        </div>
      </div>

      <div>
        <h3 style="margin:0 0 6px">Cheat-sheet</h3>
        <div class="legend">
          <b>Type:</b> even N ‚Üí <b>Basic</b>; odd N ‚Üí <b>Bounce</b>.<br/>
          <b>Side (Basic):</b> <b>Left</b> if N ‚â° 0 or 2 (mod 8); otherwise <b>Right</b>.<br/>
          <b>Side (Bounce):</b> apply the same rule to <b>N + 1</b>.<br/>
          <b>Fast Tap:</b> tap where you‚Äôd say "1".<br/>
          <b>TTS:</b> enable "Speak number" and (optionally) choose a voice.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Start Guide modal -->
<div class="modal" id="qsModal">
  <div class="inner">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Quick Start Guide</h2>
      <button id="closeQS" title="Close">Close</button>
    </div>
    <div class="hr"></div>

    <div class="grid2">
      <div>
        <h3 style="margin:0 0 6px">What this trainer does</h3>
        <div class="legend">
          This app trains the <b>Quinta principle</b>: forcing the <b>2nd item from the left</b> out of five.  
          You‚Äôll practice choosing the correct <b>Counting Type</b> (Basic or Bounce)  
          and the right <b>Starting Side</b> for any number <i>N</i>.  
          The goal is speed and accuracy ‚Äî so the force feels natural and automatic.
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 6px">2-Minute Training Flow</h3>
        <ol class="legend" style="padding-left:18px">
          <li>Select a <b>Range</b> (or set <b>Custom</b>). Keep <b>Adaptive</b> ON ‚Äî it will prioritize what you‚Äôre slowest at.</li>
          <li>Press <b>Generate number</b> to get a random N.</li>
          <li><b>Fast Tap Mode</b>: simply tap the square where you‚Äôd count ‚Äú1‚Äù. (No need to pick Type/Side/Check.)</li>
          <li>(Optional) Enable <b>Speak number</b> (TTS). It auto-detects your device language, or you can pick a voice manually.</li>
          <li>(Optional) Turn on <b>Speak errors</b> ‚Äî you‚Äôll hear a quick ‚Äúwrong‚Äù in your chosen language when you miss.</li>
          <li>Correct answers instantly trigger the next number. Wrong answers give feedback + repeat.</li>
        </ol>
      </div>

      <div>
        <h3 style="margin:0 0 6px">Rules (Cheat-Sheet)</h3>
        <div class="legend">
          <b>Force item:</b> always the <b>2nd from the left</b>.<br/>
          <b>Type:</b> even N ‚Üí <b>Basic</b>; odd N ‚Üí <b>Bounce</b>.<br/>
          <b>Side (Basic):</b> Start <b>Left</b> if N ‚â° 0 or 2 (mod 8); otherwise start <b>Right</b>.<br/>
          <b>Side (Bounce):</b> Add 1 to N, then apply the same rule as Basic.<br/>
          <b>Fast Tap:</b> Tap where you‚Äôd say ‚Äú1‚Äù ‚Äî the app handles Type/Side logic for you.<br/>
          <b>TTS & Errors:</b> ‚ÄúSpeak number‚Äù reads the target; ‚ÄúSpeak errors‚Äù confirms mistakes aloud.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Adaptive Settings modal -->
<div class="modal" id="adaptModal">
  <div class="inner">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Adaptive settings</h2>
      <button id="closeAdapt" title="Close">Close</button>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div>
        <div class="legend">Define when your time is considered ‚Äúfast‚Äù or ‚Äúslow‚Äù.</div>
        <div class="hr"></div>
        <label class="legend">Fast if ‚â§
          <input id="fastTh" type="number" min="0.1" step="0.1" style="width:90px"> s
        </label>
        <br>
        <label class="legend">Slow if ‚â•
          <input id="slowTh" type="number" min="0.1" step="0.1" style="width:90px"> s
        </label>
        <div class="legend" style="margin-top:8px">Rule: <b>Fast &lt; Slow</b>.</div>
      </div>
      <div>
        <div class="legend">
          ‚Ä¢ ‚â§ Fast: decreases the frequency of that bucket.<br>
          ‚Ä¢ ‚â• Slow: increases the frequency of that bucket.<br>
          ‚Ä¢ Between Fast and Slow: gentle adjustment.
        </div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="saveAdapt" title="Save">Save</button>
      <button id="closeAdapt2" title="Close">Close</button>
    </div>
  </div>
</div>

<!-- Easter Egg modal (every 100) -->
<div class="modal" id="eggModal">
  <div class="inner">
    <h2 id="eggTitle">Milestone!</h2>
    <div class="legend" style="font-size:16px;margin:8px 0 14px">
      <b id="eggMsg">You‚Äôre good enough ‚Äî go practice in the real world.</b>
    </div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="eggContinue">Continue training</button>
      <button id="eggReset">Reset counters</button>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  // ===== helpers =====
  function $(s){ return document.querySelector(s); }
  var numberEl=$('#number'),feedback=$('#feedback');
  var okEl=$('#ok'),errEl=$('#err'),timerEl=$('#timer');
  var nextBtn=$('#nextBtn'),checkBtn=$('#checkBtn'),resetBtn=$('#resetBtn');
  var helpBtn=$('#helpBtn'),modal=$('#modal'),closeHelp=$('#closeHelp');
  var qsBtn=$('#qsBtn'),qsModal=$('#qsModal'),closeQS=$('#closeQS');
  var tBasic=$('#tBasic'),tBounce=$('#tBounce'),sLeft=$('#sLeft'),sRight=$('#sRight');
  var stepCB=$('#step');
  var rangeSel=$('#range'),customWrap=$('#customWrap'),minN=$('#minN'),maxN=$('#maxN');
  var adaptiveCB=$('#adaptiveCB'),fastCB=$('#fastCB'),ttsCB=$('#ttsCB'),errTtsCB=$('#errTtsCB');
  var voiceSel=$('#voiceSel');
  var manualN=$('#manualN'),analyzeBtn=$('#analyzeBtn'),manualOut=$('#manualOut');
  var board=$('#board'),advancedControls=$('#advancedControls'),hintEl=$('#hint');
  var adaptCfgBtn=$('#adaptCfgBtn');
  var adaptModal=$('#adaptModal'), closeAdapt=$('#closeAdapt'), saveAdapt=$('#saveAdapt'), closeAdapt2=$('#closeAdapt2');
  var fastThIn=$('#fastTh'), slowThIn=$('#slowTh');
  var timeLegend=$('#timeLegend');

  var eggModal=$('#eggModal'), eggTitle=$('#eggTitle'), eggMsg=$('#eggMsg'), eggContinue=$('#eggContinue'), eggReset=$('#eggReset');

  // ===== state =====
  var N=null,lastN=null,startTime=0,ok=0,err=0,locked=false;
  var weights=[1,1,1,1]; // BL, BR, bL, bR

  // thresholds
  var fastThreshold = Number(localStorage.getItem('q_fastTh') || '3.0');
  var slowThreshold = Number(localStorage.getItem('q_slowTh') || '5.0');

  function updateTimeLegend(){
    if(timeLegend){
      timeLegend.textContent = 'Good ‚â§ ' + fastThreshold.toFixed(1) + 's ‚Ä¢ Slow ‚â• ' + slowThreshold.toFixed(1) + 's';
    }
  }

  // ===== timer =====
  function now(){ return performance.now(); }
  function updateTimer(){
    if(startTime && timerEl){ timerEl.textContent=((now()-startTime)/1000).toFixed(1)+'s'; }
    requestAnimationFrame(updateTimer);
  }
  requestAnimationFrame(updateTimer);

  // ===== range =====
  function currentRange(){
    if(rangeSel.value==='custom'){
      var a=parseInt(minN.value||'1',10), b=parseInt(maxN.value||'15',10);
      if(a>b){ var tmp=a; a=b; b=tmp; }
      if(a<1) a=1;
      if(b>9999) b=9999;
      return [a,b];
    }
    var parts=rangeSel.value.split('-');
    return [parseInt(parts[0],10), parseInt(parts[1],10)];
  }

  // ===== rules =====
  function correctRule(n){
    var tipo=(n%2===0)?'basic':'bounce';
    var m=(tipo==='bounce')?n+1:n;
    var r=((m%8)+8)%8;
    var lado=(r===0||r===2)?'left':'right';
    return {tipo:tipo,lado:lado,r:r,m:m};
  }
  function bucketFromRule(rule){
    if(rule.tipo==='basic'&&rule.lado==='left') return 0;
    if(rule.tipo==='basic'&&rule.lado==='right') return 1;
    if(rule.tipo==='bounce'&&rule.lado==='left') return 2;
    return 3;
  }

  // ===== adaptive generator =====
  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function sampleBucketAvailable(a,b){
    var seen={};
    var i=0;
    while(i<400){
      i++;
      var n=randInt(a,b);
      var r=bucketFromRule(correctRule(n));
      seen[r]=true;
      if(seen[0]&&seen[1]&&seen[2]&&seen[3]) break;
    }
    return seen;
  }
  function pickBucket(a,b){
    var avail=sampleBucketAvailable(a,b);
    var eff=[0,0,0,0], sum=0, i;
    for(i=0;i<4;i++){
      if(avail[i]){ eff[i]=adaptiveCB.checked?Math.max(0.05,weights[i]):1; sum+=eff[i]; }
    }
    var r=Math.random()*sum;
    for(i=0;i<4;i++){
      if(!avail[i]) continue;
      if(r<eff[i]) return i;
      r-=eff[i];
    }
    for(i=0;i<4;i++) if(avail[i]) return i;
    return 0;
  }

  // ===== TTS =====
  var voices=[];
  function getTargetLang(){ return navigator.language || document.documentElement.lang || 'en-US'; }
  function pickBestVoice(target){
    var t=(target||'').toLowerCase();
    var base=t.split('-')[0];
    var i,v;
    for(i=0;i<voices.length;i++){ v=voices[i]; if(v.lang && v.lang.toLowerCase()===t) return v; }
    for(i=0;i<voices.length;i++){ v=voices[i]; if(v.lang && v.lang.toLowerCase().indexOf(base)===0) return v; }
    return null;
  }
  function populateVoiceSelect(){
    var prev=voiceSel.value;
    voiceSel.innerHTML='<option value="">Auto (by language)</option>';
    var byKey={};
    function pickScore(v){ var uri=(v.voiceURI||'').toLowerCase(); var s=0; if(v.localService) s+=1; if(/premium|enhanced|siri/.test(uri)) s+=2; return s; }
    var i,v,key,cur;
    for(i=0;i<voices.length;i++){
      v=voices[i];
      key=((v.lang||'').toLowerCase())+'|'+(v.name||'');
      cur=byKey[key];
      if(!cur || pickScore(v)>pickScore(cur)) byKey[key]=v;
    }
    var preferred=['en-','pt-','es-','fr-','de-','it-','ja-','zh-','ko-'];
    var list=[], k;
    for(k in byKey){ list.push(byKey[k]); }
    list.sort(function(a,b){
      function pref(x){
        var j;
        for(j=0;j<preferred.length;j++){ if(x.lang && x.lang.toLowerCase().indexOf(preferred[j])===0) return j; }
        return 999;
      }
      var pa=pref(a), pb=pref(b);
      if(pa!==pb) return pa-pb;
      var la=(a.lang||''), lb=(b.lang||'');
      if(la!==lb) return la.localeCompare(lb);
      return a.name.localeCompare(b.name);
    });
    for(i=0;i<list.length;i++){
      v=list[i];
      var opt=document.createElement('option');
      opt.value=v.name; opt.textContent=(v.lang+' ‚Äî '+v.name);
      voiceSel.appendChild(opt);
    }
    var hasPrev=false, o;
    for(i=0;i<voiceSel.options.length;i++){ o=voiceSel.options[i]; if(o.value===prev) hasPrev=true; }
    if(hasPrev) voiceSel.value=prev;
  }
  function refreshVoices(){
    if(!('speechSynthesis' in window)) return;
    voices = window.speechSynthesis.getVoices() || [];
    populateVoiceSelect();
  }
  if('speechSynthesis' in window){
    refreshVoices();
    window.speechSynthesis.onvoiceschanged = refreshVoices;
  }

  function getActiveLang(){
    var selName = voiceSel.value;
    if(selName && voices.length){
      var i,v;
      for(i=0;i<voices.length;i++){ v=voices[i]; if(v.name===selName){ if(v.lang) return v.lang; } }
    }
    return getTargetLang();
  }
  function speakText(msg, force){
    try{
      if(!('speechSynthesis' in window)) return;
      if(!force && !ttsCB.checked) return;
      var u=new SpeechSynthesisUtterance(String(msg));
      var selName = voiceSel.value;
      if(selName && voices.length){
        var i,v;
        for(i=0;i<voices.length;i++){ v=voices[i]; if(v.name===selName){ u.voice=v; u.lang=v.lang||u.lang; break; } }
      }else{
        var lang=getActiveLang();
        var best=pickBestVoice(lang);
        if(best){ u.voice=best; u.lang=best.lang; } else { u.lang=lang; }
      }
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }
  function speakNumber(n){ speakText(n, false); }

  function errorWordFor(lang){
    var L=(lang||'en').toLowerCase();
    var base=L.split('-')[0];
    var map={
      'en':'wrong','pt':'errou','pt-pt':'erraste','es':'fallaste','fr':'rat√©','de':'falsch','it':'sbagliato',
      'ja':'‰∏çÊ≠£Ëß£„Åß„Åô','zh':'Á≠îÈîô‰∫Ü','ko':'ÌãÄÎ†∏ÏäµÎãàÎã§'
    };
    if(map[L]) return map[L];
    if(map[base]) return map[base];
    return 'wrong';
  }
  function speakError(){
    if(!errTtsCB.checked) return;
    var lang=getActiveLang();
    speakText(errorWordFor(lang), false);
  }

  // ===== Milestone (cada 100) ‚Äî fala no mesmo idioma, sempre =====
  function milestoneStringsFor(lang, milestone){
    var L=(lang||'en').toLowerCase();
    var base=L.split('-')[0];
    var dict;
    var map={
      'en':{title:function(n){return n+' reps!';}, msg:"You're good enough ‚Äî go practice in the real world."},
      'pt':{title:function(n){return n+' repeti√ß√µes!';}, msg:'Voc√™ j√° √© bom o suficiente ‚Äî v√° praticar no mundo real.'},
      'es':{title:function(n){return '¬°'+n+' repeticiones!';}, msg:'Ya eres lo bastante bueno ‚Äî sal a practicar en el mundo real.'},
      'fr':{title:function(n){return n+' r√©p√©titions !';}, msg:"Tu es d√©j√† assez bon ‚Äî va t'exercer dans le monde r√©el."},
      'de':{title:function(n){return n+' Wiederholungen!';}, msg:'Du bist gut genug ‚Äì √ºbe jetzt in der echten Welt.'},
      'it':{title:function(n){return n+' ripetizioni!';}, msg:'Sei gi√† abbastanza bravo ‚Äî vai ad allenarti nel mondo reale.'},
      'ja':{title:function(n){return n+' Âõû!';}, msg:'„ÇÇ„ÅÜÂçÅÂàÜ‰∏äÊâã„Åß„Åô„ÄÇÁèæÂÆü„ÅÆ‰∏ñÁïå„ÅßÁ∑¥Áøí„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ'},
      'zh':{title:function(n){return n+' Ê¨°!';}, msg:'‰Ω†Â∑≤ÁªèË∂≥Â§üÊ£í‰∫Ü‚Äî‚ÄîÂéªÁé∞ÂÆû‰∏≠ÁªÉ‰π†Âêß„ÄÇ'},
      'ko':{title:function(n){return n+'Ìöå!';}, msg:'Ïù¥Ï†ú Ï∂©Î∂ÑÌûà ÏûòÌï¥Ïöî ‚Äî Ïã§Ï†ú ÌôòÍ≤ΩÏóêÏÑú Ïó∞ÏäµÌï¥ Î≥¥ÏÑ∏Ïöî.'}
    };
    if(map[L]) dict=map[L]; else if(map[base]) dict=map[base]; else dict=map['en'];
    return { title: dict.title(milestone), msg: dict.msg };
  }

  // ===== simulation =====
  function simulate(n,tipo,lado,step){
    var target=1, pos=(lado==='left')?0:4, dir=(lado==='left')?+1:-1;
    var log=[];
    if(tipo==='basic'){
      var count=0;
      while(count<n){
        count++;
        if(step) log.push({count:count,pos:pos});
        if(count===n) break;
        pos+=dir;
        if(pos===4||pos===0) dir*=-1;
      }
    }else{
      var moves=0;
      while(moves<n){
        pos+=dir; moves++;
        if(step) log.push({count:moves,pos:pos});
        if(pos===4||pos===0) dir*=-1;
      }
    }
    return {hit:(pos===target),pos:pos,log:log};
  }
  function userSelection(){ return {tipo:(tBasic.checked?'basic':'bounce'), lado:(sLeft.checked?'left':'right')}; }

  // ===== adaptive weights =====
  function updateAdaptiveWeights(bucket, elapsed){
    if(!adaptiveCB.checked) return;
    var SLOW = slowThreshold, FAST = fastThreshold;
    var UP=0.3, DOWN=0.2, MIN=0.2, MAX=3.0;
    if(elapsed>=SLOW) weights[bucket]=Math.min(MAX,weights[bucket]+UP);
    else if(elapsed<=FAST) weights[bucket]=Math.max(MIN,weights[bucket]-DOWN);
    else weights[bucket]+= (1-weights[bucket])*0.05;
  }

  // ===== Easter egg (every 100) =====
  var EGG_EVERY = 100;
  var lastEggMilestone = Number(localStorage.getItem('q_lastEggMilestone') || '0');

  function checkEasterEgg(){
    var total = ok + err;
    var milestone = Math.floor(total / EGG_EVERY) * EGG_EVERY;
    if (milestone > 0 && total % EGG_EVERY === 0 && milestone !== lastEggMilestone){
      lastEggMilestone = milestone;
      localStorage.setItem('q_lastEggMilestone', String(lastEggMilestone));
      var lang = getActiveLang();
      var obj = milestoneStringsFor(lang, milestone);
      if (eggTitle) eggTitle.textContent = obj.title;
      if (eggMsg)   eggMsg.textContent   = obj.msg;
      if(eggModal) eggModal.style.display='grid';
      // Falar sempre (force=true)
      speakText(obj.title + ' ' + obj.msg, true);
      return true;
    }
    return false;
  }

  // ===== core flow =====
  function newNumber(){
    var range=currentRange(), a=range[0], b=range[1];
    var targetBucket=pickBucket(a,b);
    var candidate=null, tries=0;
    while(tries++<400){
      var x=randInt(a,b);
      if(x===lastN && b>a) continue;
      if(bucketFromRule(correctRule(x))===targetBucket){candidate=x;break;}
    }
    if(candidate===null){
      do{ candidate=(a===b? a : randInt(a,b)); } while(candidate===lastN && b>a);
    }
    N=candidate; lastN=N;
    numberEl.textContent=String(N);
    startTime=now(); feedback.textContent=''; locked=false;

    hintEl.innerHTML = fastCB.checked
      ? 'Fast Tap Mode: <b>tap where you‚Äôd say "1"</b>. (Force is the <b>2nd from the left</b>.)'
      : 'Generate a number and choose the counting type and the side. The force item is always the <b>2nd from the left</b>.';

    speakNumber(N);
  }

  function verify(){
    if(locked||N==null) return; locked=true;
    var elapsed=(now()-startTime)/1000;
    var ideal=correctRule(N);
    var sel=userSelection();
    var sim=simulate(N, sel.tipo, sel.lado, stepCB.checked);
    var idealTxt=(ideal.tipo==='basic'?'Basic':'Bounce') + ' + ' + (ideal.lado==='left'?'Left':'Right');
    var userTxt =(sel.tipo==='basic'?'Basic':'Bounce') + ' + ' + (sel.lado==='left'?'Left':'Right');

    if(sim.hit){
      ok++;
      feedback.innerHTML='<span class="ok">Correct!</span> <span class="muted">(' + userTxt + ') ‚Äî ' + elapsed.toFixed(1) + 's</span>';
    }else{
      err++;
      feedback.innerHTML='<span class="err">Wrong.</span> <span class="muted">You chose ' + userTxt + '. Ideal: <b>' + idealTxt + '</b>. ‚Äî ' + elapsed.toFixed(1) + 's</span>';
      if(stepCB.checked && sim.log.length){
        var pathArr=[], i;
        for(i=0;i<sim.log.length;i++){ pathArr.push(String(sim.log[i].pos+1)); }
        feedback.innerHTML += '<div class="muted" style="margin-top:6px">Path: ' + pathArr.join(' ‚Üí ') + '</div>';
      }
      speakError();
    }
    okEl.textContent=ok; errEl.textContent=err;
    updateAdaptiveWeights(bucketFromRule(ideal), elapsed);

    var egg = checkEasterEgg();
    if(!egg && sim.hit){ setTimeout(newNumber,500); }
  }

  function fastTap(idx){
    if(locked||N==null) return; locked=true;
    var elapsed=(now()-startTime)/1000;
    var ideal=correctRule(N);
    var startIdx=(ideal.lado==='left')?0:4;
    var isRight=(idx===startIdx);

    if(isRight){
      ok++;
      feedback.innerHTML='<span class="ok">Correct!</span> <span class="muted">(Start: <b>'+(ideal.lado==='left'?'Left':'Right')+'</b>; Type: <b>'+(ideal.tipo==='basic'?'Basic':'Bounce')+'</b>) ‚Äî '+elapsed.toFixed(1)+'s</span>';
    }else{
      err++;
      feedback.innerHTML='<span class="err">Wrong.</span> <span class="muted">You tapped '+(idx+1)+'. Ideal start is <b>'+(ideal.lado==='left'?'Left (1st)':'Right (5th)')+'</b>; Type: <b>'+(ideal.tipo==='basic'?'Basic':'Bounce')+'</b>. ‚Äî '+elapsed.toFixed(1)+'s</span>';
      speakError();
    }
    okEl.textContent=ok; errEl.textContent=err;
    updateAdaptiveWeights(bucketFromRule(ideal), elapsed);

    var egg = checkEasterEgg();
    if(!egg && isRight){ setTimeout(newNumber,350); }
  }
  window.fastTap=fastTap;

  // ===== UI events =====
  function show(el, on){ if(el) el.style.display = on ? '' : 'none'; }

  nextBtn.addEventListener('click', newNumber);
  checkBtn.addEventListener('click', function(){ if(!fastCB.checked) verify(); });
  helpBtn.addEventListener('click', function(){ if(modal) modal.style.display='grid'; });
  closeHelp.addEventListener('click', function(){ if(modal) modal.style.display='none'; });
  qsBtn.addEventListener('click', function(){ if(qsModal) qsModal.style.display='grid'; });
  closeQS.addEventListener('click', function(){ if(qsModal) qsModal.style.display='none'; });

  rangeSel.addEventListener('change', function(){ show(customWrap, rangeSel.value==='custom'); });
  resetBtn.addEventListener('click', function(){
    ok=0; err=0; okEl.textContent=0; errEl.textContent=0;
    lastN=null; feedback.textContent=''; manualOut.textContent='‚Äî'; manualN.value='';
    weights=[1,1,1,1];
    localStorage.removeItem('q_lastEggMilestone');
    lastEggMilestone = 0;
    newNumber();
  });

  // keyboard shortcuts
  document.addEventListener('keydown', function(e){
    var kRaw=e.key||''; var k=kRaw.toLowerCase();
    if(k==='n'){ e.preventDefault(); newNumber(); return; }
    if(kRaw==='Enter' && !e.ctrlKey){ e.preventDefault(); if(!fastCB.checked) verify(); return; }
    if(kRaw==='Enter' && e.ctrlKey){ e.preventDefault(); analyzeManual(); return; }
    if(k==='h'){ e.preventDefault(); if(modal) modal.style.display='grid'; return; }
    if(k==='q'){ e.preventDefault(); if(qsModal) qsModal.style.display='grid'; return; }

    var el=document.activeElement;
    var isEditable=el && (el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.isContentEditable||el.tagName==='SELECT');
    if(isEditable) return;

    if(k==='arrowup'||k==='w'){ e.preventDefault(); tBasic.checked=true; return; }
    if(k==='arrowdown'||k==='s'){ e.preventDefault(); tBounce.checked=true; return; }
    if(k==='arrowleft'||k==='a'){ e.preventDefault(); sLeft.checked=true; return; }
    if(k==='arrowright'||k==='d'){ e.preventDefault(); sRight.checked=true; return; }
    if(k===' '||k==='spacebar'){ e.preventDefault(); (tBasic.checked?tBounce:tBasic).checked=true; return; }
  });

  // manual analysis
  function analyzeManual(){
    var raw=(manualN.value||'').trim();
    if(!raw){ manualOut.textContent='‚Äî'; return; }
    var n=Number(raw);
    if(!isFinite(n)||Math.floor(n)!==n||n<=0){
      manualOut.innerHTML='<span class="err">Enter a positive integer.</span>'; return;
    }
    var rule=correctRule(n);
    (rule.tipo==='basic'?tBasic:tBounce).checked=true;
    (rule.lado==='left'?sLeft:sRight).checked=true;
    manualOut.innerHTML='<span class="ok">'+(rule.tipo==='basic'?'Basic':'Bounce')+' + '+(rule.lado==='left'?'Left':'Right')+'</span> <span class="muted">(N='+n+(rule.tipo==='bounce'?', use N+1='+rule.m:'')+'; mod8='+rule.r+')</span>';
  }
  analyzeBtn.addEventListener('click', analyzeManual);
  manualN.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); analyzeManual(); } });

  // Fast Tap handlers
  function getIdxFromEvent(ev){
    var t=ev.target.closest('.item');
    if(!t || !board.contains(t)) return null;
    var idx=Number(t.getAttribute('data-idx'));
    return isFinite(idx)?idx:null;
  }
  function onTap(ev){
    if(ev.type==='touchstart') ev.preventDefault();
    var idx=getIdxFromEvent(ev);
    if(idx==null || !fastCB.checked) return;
    var el=ev.target.closest('.item');
    if(el){ el.style.outline='2px solid var(--accent)'; setTimeout(function(){ el.style.outline=''; },120); }
    fastTap(idx);
  }
  board.addEventListener('click', onTap, {passive:true});
  board.addEventListener('touchstart', onTap, {passive:false});
  var items=board.querySelectorAll('.item');
  for(var i=0;i<items.length;i++){
    (function(i2){
      items[i2].onclick=function(){ if(window.fastTap) window.fastTap(i2); };
    })(i);
  }

  // UI sync
  function syncFastModeUI(){
    var on=fastCB.checked;
    advancedControls.classList.toggle('hide', on);
    checkBtn.classList.toggle('hide', on);
    hintEl.innerHTML = on
      ? 'Fast Tap Mode: <b>tap where you‚Äôd say "1"</b>. (Force is the <b>2nd from the left</b>.)'
      : 'Generate a number and choose the counting type and the side. The force item is always the <b>2nd from the left</b>.';
  }
  fastCB.addEventListener('change', syncFastModeUI);

  // Adaptive UI
  function openAdaptModal(){
    fastThIn.value = fastThreshold.toFixed(1);
    slowThIn.value = slowThreshold.toFixed(1);
    adaptModal.style.display='grid';
  }
  function closeAdaptModal(){ adaptModal.style.display='none'; }
  function syncAdaptiveUI(){ adaptCfgBtn.disabled = !adaptiveCB.checked; }
  adaptiveCB.addEventListener('change', syncAdaptiveUI);
  adaptCfgBtn.addEventListener('click', function(){ if(!adaptCfgBtn.disabled) openAdaptModal(); });
  if(closeAdapt) closeAdapt.addEventListener('click', closeAdaptModal);
  if(closeAdapt2) closeAdapt2.addEventListener('click', closeAdaptModal);
  saveAdapt.addEventListener('click', function(){
    var f = Number(fastThIn.value), s = Number(slowThIn.value);
    if(!isFinite(f)||!isFinite(s)||f<=0||s<=0){ alert('Use positive numeric values.'); return; }
    if(f >= s){ alert('Fast must be less than Slow.'); return; }
    fastThreshold = f; slowThreshold = s;
    localStorage.setItem('q_fastTh', String(fastThreshold));
    localStorage.setItem('q_slowTh', String(slowThreshold));
    updateTimeLegend();
    closeAdaptModal();
  });

  // Easter egg buttons
  eggContinue.addEventListener('click', function(){ if(eggModal) eggModal.style.display='none'; });
  eggReset.addEventListener('click', function(){
    ok=0; err=0; okEl.textContent=0; errEl.textContent=0;
    localStorage.removeItem('q_lastEggMilestone');
    lastEggMilestone = 0;
    if(eggModal) eggModal.style.display='none';
    newNumber();
  });

  // init
  function init(){
    updateTimeLegend();
    syncFastModeUI();
    syncAdaptiveUI();
    newNumber();
  }
  init();

})(); 
</script>
</body>
</html>

